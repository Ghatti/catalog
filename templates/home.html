<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="google-signin-scope" content="profile email">
        <meta name="google-signin-client_id" content="503094252642-9sjga5hc32c4iiau869inpbcr1s9u043.apps.googleusercontent.com">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="{{url_for('static', filename='css/main.css') }}">
        <title>Catalog App</title>
    </head>
    <body class="container">
        <header class="jumbotron mt-3 text-center">
            <h1>Catalog App</h1>

            <nav class="nav justify-content-center mt-4">

                {%if userId%}

                    <div class="nav-item">
                        <a class="nav-link manage-link" href={{ url_for("newCategory") }}>Add Category</a>
                    </div>
                    <div class="nav-item">
                        <a class="nav-link manage-link" href={{ url_for("newItem") }} >Add item</a>
                    </div>
                    <div class="nav-item">
                        <a class="nav-link manage-link" href="#" onclick="signOut();"> Logout</a>
                    </div>
                    
                {%endif%}
                {%if not userId %}
                    <div id="g-signin" class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
                {%endif%}                

            </nav>

            <section class="mt-3">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        <ul>
                            {%for message in messages%}
                                <li><strong class="text-danger">{{message}}</strong></li>
                            {%endfor%}
                        </ul>
                    {%endif%}
                {%endwith%}
            </section>
        </header>

        <Main class="row">

            <section class="col-12 col-md-6 text-center mt-3">
                <div>
                    <h2>Categories</h2>
                    <ul class="mt-4">
                        {%if categories%}
                        {% for category in categories%}
                            <li class="mt-1"><a class="link" href={{url_for("showCategory", category_id = category.id )}}>{{category.name}}</a></li>
                        {%endfor%}
                        {%endif%}
                    </ul>
                </div>
            </section>
            <section  class="col-12 col-md-6 text-center mt-3">
                <h2>Latest items</h2>
                <ul class="mt-4">
                    {%if latest%}
                    {%for item in latest%}
                        <li class="mt-1"><a class="link" href={{url_for("showItem", category_id = item.category_id, item_id = item.id)}}>{{item.name}}</a> - {{item.creation_date.date()}}</li>
                    {%endfor%}
                    {%endif%}
                </ul>

            </section>
        </Main>

        <script>

            function onSignIn(googleUser) {
              
                // The ID token you need to pass to your backend:
                var id_token = googleUser.getAuthResponse().id_token;
        
                $("#g-signin").click(function(){
                    $.ajax({
                        type: "POST", 
                        url: "/gconnect?state={{STATE}}",
                        processData: false,
                        data: id_token,
                        contentType: 'application/octet-stream; charset=utf-8',
                        success: function(result) {
                            if (result){
                                window.location.href = "/catalog";
                            }
                            else if (authResult['error']) {
                                console.log('There was an error:');
                            } else {
                                console.log('Failed to make a server-side call. Check your configuration and console.');
                            }
                        }
                    })
                })

            }

            function signOut() {
                
                $.ajax({
                    type: "GET",
                    url: "/gdisconnect",
                    success: function(result) {
                        if(result){
                            window.location.href = "/catalog";
                        } else {
                            console.log("Failed to disconnect")
                        }
                    }
                })   
            }   

        </script>
    </body>
</html>